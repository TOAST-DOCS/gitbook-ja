## Storage > Backup > コンソール使用ガイド

## バックアップエージェント(agent)
バックアップするサーバーを登録するには、まず対象のサーバーにエージェント(agent)をインストールする必要があります。エージェントをインストールする時は、ユーザーのドメイン情報が必要です。 ドメイン情報は**サーバー登録** ページで確認できます。

* ユーザーのドメイン
```
/TCBackup/{domain-id}
```

> [参考]
> ドメインは、多くのサーバーをグループ化して管理するために使用する、バックアップシステムの単位です。
> ドメインは、バックアップサービスを有効にすると自動的に作成されます。
> ユーザーのドメインにバックアップするサーバーを登録には、エージェントのインストールコマンドのパラメータにドメイン情報を入力します。

<br/>

### サーバーセキュリティーグループ(security group)設定

バックアップサーバーと通信するには、サーバーセキュリティーグループに下記の内容を追加します。

| 方向(direction) | ポート  | リージョン | CIDR |
| --- | --- | --- | --- |
| Ingress/Egress | ALL TCP | 韓国(パンギョ) | 133.186.132.0/24 |
| | | 韓国(ピョンチョン) | 133.186.207.4/32, 133.186.207.5/32 |
| | | 日本(東京) | 133.223.17.0/24 |
| Egress | 443 | 韓国(パンギョ) | 103.243.202.188/32 |
| | | 韓国(ピョンチョン) | 103.243.202.188/32 |
| | | 日本(東京) | 119.235.231.50/32 |

<br/>

### バックアップCLIのインストール

* **Linux**

| リージョン | URL |
| --- | --- |
| 韓国(パンギョ) | https://static.toastoven.net/toastcloud/sdk_download/backup/scripts/linux/bootstrap.sh |
| 韓国(ピョンチョン) | https://static.toastoven.net/toastcloud/sdk_download/backup/kr2/scripts/linux/bootstrap.sh |
| 日本(東京) | https://static.toastoven.net/toastcloud/sdk_download/backup/jp/scripts/linux/bootstrap.sh |

```
curl {URL} | bash
```

<br/>

### バックアップエージェントのインストール

> [注意]
> バックアップは、エージェントがインストールされたサーバーのホスト名でサーバーを登録します。
> 1つのユーザードメイン内に同じホスト名で複数のサーバーを登録する場合、バックアップが実行されない可能性があります。
> エージェントをインストールする前に、ホスト名が重複していないことを確認してください。

次のようにエージェントをインストールします。

* **Linux**

```
tcbackup install {user-domain}
```

<br/>

* **Windows**

Windows用エージェントは、[NHN Cloudのダウンロードページ](https://docs.toast.com/ja/Download)からダウンロードしてインストールします。インストール中、 MC ServerとMC Domain情報を入力する必要があります。MC Domainはユーザーのドメイン情報です。MC Serverには次の情報を入力します。

| リージョン | MC Server |
| --- | --- |
| 韓国(パンギョ) | tcbackup1.toastmaker.net |
| 韓国(ピョンチョン) | kr2-backup-mc1.cloud.toast.com |
| 日本(東京) | tcbackup.nhn-japan.com |

<br/>


### バックアップエージェントの再登録
バックアップするサーバーのホスト名が変更された場合、エージェントを再び登録する必要があります。再登録コマンドは次のとおりです。

* **Linux**

```
tcbackup re-register
```

<br/>

* **Windows**

下記のPowerShellスクリプトをダウンロードして実行します。

[re-register.ps1](https://static.toastoven.net/toastcloud/sdk_download/backup/scripts/windows/re-register.ps1)


<br/>

### バックアップエージェントの終了
しばらくバックアップを中断したい時はエージェントを終了できます。

* **Linux**

```
tcbackup stop
```

<br/>

* **Windows**

システムトレイでバックアップエージェントのアイコンを右クリックして**終了**をクリックします。

<br/>

### バックアップエージェントの再起動
終了したバックアップエージェントを再び起動するには次のコマンドを使用します。

* **Linux**

```
tcbackup restart
```

<br/>

* **Windows**

スタートメニューから**EMC Avamar > Client**を実行します。

<br/>

## サーバーの登録
バックアップするサーバーにエージェントをインストールすると、**サーバー登録**画面の **サーバー選択**項目でエージェントが登録されたサーバーのホスト名を選択できます。すでに登録したサーバーは選択リストから除外されます。

<br/>


### バックアップ計画の追加
1つのサーバーに複数のバックアップ計画を追加できます。バックアップ計画の追加は、サーバー登録が完了した後にも行えます。

> [注意]
> バックアップは、サーバーに負荷をかけないようにバックグラウンドでゆっくり行われます。
> **1TB以上の大容量データ**または**100万個を超える大量のファイル**をバックアップする場合は、最大実行時間の3時間を超過して、バックアップが失敗することがあります。
> バックアップするパスのデータが基準量を超えている場合、パスを分けて順次バックアップできるように設定することを推奨します。
> NAS(offline)サービスのデータまたは非常に大きい容量のデータをバックアップする計画がある場合は、サポートへお問い合わせください。

* **バックアップパス**

バックアップするパスを指定します。絶対パスを正確に入力する必要があります。パスの入力に誤りがあると、バックアップの失敗や、望んでいないパスがバックアップされる場合があります。 Soft linkをバックアップパスに設定すると、 soft link fileのみバックアップされます。

```
例)
Windows :   c:\backup
Linux   :   /home/backup
```

<br/>

* **バックアップ周期**

バックアップを実行する周期です。1日間隔、7日間隔の中から選択できます。

<br/>

* **バックアップ時刻**

バックアップを開始する時刻です。1時間単位で選択できます。ファイル変更が最も少なく、サーバーがアイドル状態の時刻を推奨します。実際のバックアップ時刻は、状況に応じて最長1時間程度の差が生じることがあります。

<br/>

* **バックアップの保管周期**

バックアップされたコピーを保管する期間です。7日、14日、21日、30日、6月(180日)、1年(365日)、3年(1095日)、5年(1825日)の中から選択できます。

<br/>

### バックアップ計画のリスト
サーバーリストでサーバー名の左にあるチェックボックスを選択すると、画面下の詳細画面に、選択したサーバーのバックアップ計画リストが表示されます。

<br/>

### バックアップ結果と照会
バックアップ計画リストからバックアップパスをクリックすると、バックアップ結果を照会できます。バックアップ結果は、バックアップ完了時刻から最長1時間以内に集計されます。

| バックアップ結果 | 意味 |
| --- | --- |
| 成功 | バックアップ成功 |
| 成功(注意) | バックアップを完了したが、バックアップ中に原本ファイルが変更された |
| 失敗 | バックアップ失敗 |

> [参考]
> ネットワーク状態とバックアップデータの容量、同じ時間に開始するように設定された多くのバックアップスケジュールなどにより、3時間以内にバックアップが完了しない場合、そのスケジュールは失敗として記録されます。

<br/>

### バックアップポリシーの変更

バックアップ計画リストから各項目の右にある**変更** ボタンをクリックすると、バックアップポリシーを変更できます。変更できる項目は`バックアップ周期`、 `バックアップ時刻`、 `保管周期`です。

<br/>

## 復旧申請
登録したバックアップ計画が1回以上バックアップされると、そのデータで復旧を申請できます。

* **バックアップパス**

ユーザーが追加したバックアップパスの中から1つを選択できます。

<br/>

* **バックアップ日時**

復旧するコピーがバックアップされた日時を選択できます。一度もバックアップされていない場合や、全て失敗して復旧できるバックアップデータがない場合、復旧するデータがないというメッセージが表示されます。

<br/>

* **申請事項**

復旧に必要な詳細事項は自由に申請できます。バックアップしたサーバーにそのまま復旧できますが、新しいサーバーに復旧することもできます。

```
例)
復旧するサーバーのホスト名   ： backup.guide
復旧するパス ： /home/debian
```

<br/>

* **連絡先**

スムーズな復旧のため、担当者と申請者の間の窓口として使用する連絡先を入力します。収集された個人情報は保存されず、復旧が完了したら即時廃棄されます。

復旧の進行状態は次の表のように表示されます。

| 状態 | 意味 |
| --- | --- |
| 受付 | 復旧リクエストが受け付けられた |
| 進行中 | 運営者が復旧を開始した |
| 完了 | 復旧完了 |


<br/>

## サーバー登録の解除
サーバー登録を解除する前に、必ず登録したバックアップ計画を削除する必要があります。バックアップ計画が残っている場合、案内メッセージが表示され、解除が中断されます。

> [注意]
> サーバー登録を解除すると、保管されたバックアップデータも削除されます。バックアップデータが必要な場合は、あらかじめ復旧要請を行い、希望するサーバーに復旧する必要があります。
>

サーバー登録を解除した後は、必ずサーバーに接続してエージェントを停止させ、エージェント登録を解除する必要があります。それを行わない場合、そのサーバーを再登録できません。解除コマンドは次のとおりです。

* **Linux**

```
tcbackup uninstall
```

<br/>

* **Windows**

エージェントを終了します。次に再び使用する時は、クライアント有効化の項目を開いて新しいドメイン情報を入力します。
