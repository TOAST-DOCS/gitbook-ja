## Storage > Backup > コンソール使用ガイド

## バックアップエージェント(agent)
バックアップするサーバーを登録するには、まず対象のサーバーにエージェント(agent)をインストールする必要があります。エージェントをインストールする時は、ユーザーのドメイン情報が必要です。 ドメイン情報は**サーバー登録** ページで確認できます。

* ユーザーのドメイン
```
/TCBackup/{domain-id}
```

> [参考]  
> ドメインは、多くのサーバーをグループ化して管理するために使用する、バックアップシステムの単位です。
> ドメインは、バックアップサービスを有効にすると自動的に作成されます。
> ユーザーのドメインにバックアップするサーバーを登録には、エージェントのインストールコマンドのパラメータにドメイン情報を入力します。
>

<br/>

### サーバーセキュリティーグループ(security group)設定

バックアップサーバーと通信するには、サーバーセキュリティーグループに下記の内容を追加します。

| 方向(direction) | ポート | CIDR |
| --- | --- | --- |
| Ingress/Egress | ALL TCP | 211.180.235.123/32<br/>211.180.235.124/32<br/>211.180.235.106/32<br/>211.180.235.122/32 |

<br/>

### バックアップCLIのインストール

* **Linux**

```
curl https://static.toastoven.net/toastcloud/sdk_download/gov-backup/scripts/linux/bootstrap.sh | bash
```

<br/>

### バックアップエージェントのインストール

> [注意]
> バックアップは、エージェントがインストールされたサーバーのホスト名でサーバーを登録します。
> 1つのユーザードメイン内に同じホスト名で複数のサーバーを登録する場合、バックアップが実行されない可能性があります。
> エージェントをインストールする前に、ホスト名が重複していないことを確認してください。

次のようにエージェントをインストールします。

* **Linux**

```
tcbackup install {user-domain}
```

<br/>

* **Windows**

Windows用エージェントは、[NHN Cloudのダウンロードページ](https://docs.toast.com/ja/Download)からダウンロードしてインストールします。インストール中、 MC ServerとMC Domain情報を入力する必要があります。MC Domainはユーザーのドメイン情報です。MC Serverには次の情報を入力します。

```
MC Server : tc0backup2.toastmaker.net
```

<br/>

### バックアップエージェントの再登録
バックアップするサーバーのホスト名が変更された場合、エージェントを再び登録する必要があります。再登録コマンドは次のとおりです。

* **Linux**

```
tcbackup re-register
```

<br/>

* **Windows**

下記のPowerShellスクリプトをダウンロードして実行します。

```
https://static.toastoven.net/toastcloud/sdk_download/backup/scripts/windows/re-register.ps1
```

<br/>

### バックアップエージェントの終了
しばらくバックアップを中断したい時はエージェントを終了できます。

* **Linux**

```
tcbackup stop
```

<br/>

* **Windows**

システムトレイでバックアップエージェントのアイコンを右クリックして**終了**をクリックします。

<br/>

### バックアップエージェントの再起動
終了したバックアップエージェントを再び起動するには次のコマンドを使用します。

* **Linux**

```
tcbackup restart
```

<br/>

* **Windows**

スタートメニューから**EMC Avamar > Client**を実行します。

<br/>

## サーバーの登録
バックアップするサーバーにエージェントをインストールすると、**サーバー登録**画面の **サーバー選択**項目でエージェントが登録されたサーバーのホスト名を選択できます。すでに登録したサーバーは選択リストから除外されます。

<br/>

### バックアップパスの追加
1つのサーバーに複数のバックアップパスを追加できます。バックアップパスの追加は、サーバー登録が完了した後にも行えます。

* **バックアップパス**

バックアップするパスを指定します。絶対パスを正確に入力する必要があります。パスの入力に誤りがあると、バックアップの失敗や、望んでいないパスがバックアップされる場合があります。 Soft linkをバックアップパスに設定すると、 soft link fileのみバックアップされます。

```
例)
Windows :   c:\backup
Linux   :   /home/backup
```

<br/>

* **バックアップ周期**

バックアップを実行する周期です。1日間隔、7日間隔の中から選択できます。

<br/>

* **バックアップ時刻**

バックアップを開始する時刻です。1時間単位で選択できます。ファイル変更が最も少なく、サーバーがアイドル状態の時刻を推奨します。実際のバックアップ時刻は、状況に応じて最長1時間程度の差が生じることがあります。

<br/>

* **バックアップの保管周期**

バックアップされたコピーを保管する期間です。7日、14日、21日、30日、6月(180日)、1年(365日)、3年(1095日)、5年(1825日)の中から選択できます。

<br/>

### バックアップパスのリスト
サーバーリストでサーバー名の左にあるチェックボックスを選択すると、画面下の詳細画面に、選択したサーバーのバックアップパスリストが表示されます。

<br/>

### バックアップ結果と照会
バックアップパスリストからバックアップパスをクリックすると、バックアップ結果を照会できます。バックアップ結果は、バックアップ完了時刻から最長1時間以内に集計されます。

| バックアップ結果  | 意味                          |
| ------ | --------------------------- |
| 成功     | バックアップ成功                       |
| 成功(注意) | バックアップを完了したが、バックアップ中に原本ファイルが変更された |
| 失敗     | バックアップ失敗                       |

> [参考]
> ネットワーク状態とバックアップデータの容量、同じ時間に開始するように設定された多くのバックアップスケジュールなどにより、3時間以内にバックアップが完了しない場合、そのスケジュールは失敗として記録されます。
>

<br/>

### バックアップポリシーの変更

バックアップパスリストから各項目の右にある**変更** ボタンをクリックすると、バックアップポリシーを変更できます。変更できる項目は`バックアップ周期`、 `バックアップ時刻`、 `保管周期`です。

<br/>

## 復旧申請
登録したバックアップパスが1回以上バックアップされると、そのデータで復旧を申請できます。

* **バックアップパス**

ユーザーが追加したバックアップパスの中から1つを選択できます。

<br/>

* **バックアップ日時**

復旧するコピーがバックアップされた日時を選択できます。一度もバックアップされていない場合や、全て失敗して復旧できるバックアップデータがない場合、復旧するデータがないというメッセージが表示されます。

<br/>

* **要請事項**

復旧に必要な詳細事項は自由に要請できます。バックアップしたサーバーにそのまま復旧できますが、新しいサーバーに復旧することもできます。

```
例)
復旧するサーバーのホスト名   ： backup.guide
復旧するパス ： /home/debian
```

<br/>

* **連絡先**

円滑な復旧のため、担当者と要請者の間の会話チャンネルとして使用する連絡先を入力します。収集された個人情報は保存されず、復旧が完了したら即時に廃棄します。

復旧進行状態は次の表のように表示されます。

| 状態   | 意味           |
| ---- | ------------ |
| 入信   | 復旧要請を入信した   |
| 進行中 | 運営者が復旧を開始した |
| 完了   | 復旧完了        |


<br/>

## サーバー登録の解除
サーバー登録を解除する前に、必ず登録したバックアップ計画を削除する必要があります。バックアップ計画が残っている場合、案内メッセージが表示され、解除が中断されます。

> [注意]
> サーバー登録を解除すると、保管されたバックアップデータも削除されます。バックアップデータが必要な場合は、あらかじめ復旧要請を行い、希望するサーバーに復旧する必要があります。
>

サーバー登録を解除した後は、必ずサーバーに接続してエージェントを停止させ、エージェント登録を解除する必要があります。それを行わない場合、そのサーバーを再登録できません。解除コマンドは次のとおりです。

* **Linux**

```
tcbackup uninstall
```

<br/>

* **Windows**

エージェントを終了します。次に再び使用する時は、クライアント活性化項目を開いて新しいドメイン情報を入力します。
